<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Vivi Variedades</title>
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Vivi Variedades">
    <link rel="manifest" href="./manifest.json">
    <!-- Estilos cr√≠ticos inline para evitar tela branca -->
    <style>
        body { margin: 0; padding: 0; overflow: hidden; }
        #loadingScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .loading-content {
            text-align: center;
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        .loading-logo {
            font-size: 72px;
            margin-bottom: 20px;
            animation: pulse 2s ease-in-out infinite;
        }
        .loading-title {
            font-size: 28px;
            font-weight: 700;
            margin: 0 0 10px 0;
        }
        .loading-subtitle {
            font-size: 14px;
            opacity: 0.9;
            margin: 0 0 30px 0;
        }
        .spinner {
            width: 60px;
            height: 60px;
            margin: 0 auto 20px;
            border: 5px solid rgba(255, 255, 255, 0.2);
            border-top: 5px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }
    </style>
    <link rel="stylesheet" href="style.css?v=1.8.0">
    <script>
        // Registrar Service Worker para PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('Service Worker registrado com sucesso:', registration.scope);
                    })
                    .catch(error => {
                        console.log('Falha ao registrar Service Worker:', error);
                    });
            });
        }
        
        // Controle de vers√£o
        const CURRENT_VERSION = '1.8.0';
        localStorage.setItem('appVersion', CURRENT_VERSION);
    </script>
</head>
<body class="loading">
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-content">
            <div class="loading-logo">üõí</div>
            <h1 class="loading-title">Vivi Variedades</h1>
            <p class="loading-subtitle">Controle de vendas</p>
            <div class="spinner"></div>
            <p>Carregando...</p>
        </div>
    </div>

    <!-- Tela de Login -->
    <div id="loginScreen" class="login-screen" style="display: none;">
        <div class="login-container">
            <div class="login-header">
                <h1>Vivi Variedades</h1>
                <p>Controle de vendas</p>
            </div>

            <div id="emailTab" class="tab-content active">
                <form id="loginForm">
                    <input type="email" id="loginEmail" placeholder="Email" required>
                    <input type="password" id="loginPassword" placeholder="Senha" required>
                    <button type="submit" class="btn btn-primary">Entrar</button>
                </form>
            </div>
        </div>
    </div>

    <!-- App Principal -->
    <div id="appScreen" class="container" style="display: none;">
        <header>
            <div class="header-content">
                <div>
                    <h1>Vivi Variedades</h1>
                    <p class="subtitle">Controle de vendas</p>
                </div>
                <div class="user-info">
                    <span id="userEmail" class="user-email"></span>
                    <button id="logoutBtn" class="btn btn-logout">Sair</button>
                </div>
            </div>
        </header>

        <main>
            <!-- Formul√°rio para registrar venda -->
            <section class="card">
                <h2>Registrar Venda Fiada</h2>
                <form id="addSaleForm">
                    <div class="autocomplete-wrapper">
                        <input 
                            type="text" 
                            id="clientSearch" 
                            placeholder="Digite o nome do cliente ou adicione novo"
                            autocomplete="off"
                            required>
                        <div id="clientSuggestions" class="suggestions-dropdown"></div>
                    </div>
                    <input type="number" id="saleAmount" placeholder="Valor (R$)" step="0.01" min="0.01" required>
                    <textarea id="saleDescription" placeholder="Descri√ß√£o ou produto (opcional)" rows="3"></textarea>
                    <label class="checkbox-label">
                        <input type="checkbox" id="justNoteProduct">
                        <span>üìù Apenas anotar produto (sem valor)</span>
                    </label>
                    <button type="submit" class="btn btn-primary">+ Registrar Venda</button>
                </form>
            </section>

            <!-- Aviso de Anota√ß√µes Pendentes -->
            <div id="unpricedNotesAlert" class="alert-banner" style="display: none;">
                <div class="alert-icon">üìù</div>
                <div class="alert-content">
                    <strong>Aten√ß√£o!</strong>
                    <span id="unpricedNotesMessage">Voc√™ tem clientes com anota√ß√µes de produtos sem pre√ßo.</span>
                </div>
                <button id="closeAlert" class="alert-close" title="Fechar">&times;</button>
            </div>

            <!-- Cards de Totais -->
            <div class="totals-container">
                <div class="total-card debt-card">
                    <div class="total-label">Total a Receber</div>
                    <div class="total-value">R$ <span id="totalDebt">0,00</span></div>
                </div>
                <div class="total-card credit-card" id="creditCard" style="display: none;">
                    <div class="total-label">Cr√©dito dos Clientes</div>
                    <div class="total-value">R$ <span id="totalCredit">0,00</span></div>
                </div>
            </div>

            <!-- Lista de clientes com d√©bitos -->
            <section class="card">
                <div class="section-header">
                    <h2>Adicionar Pagamento</h2>
                </div>
                <div class="filter-search-container">
                    <input 
                        type="text" 
                        id="searchClients" 
                        placeholder="üîç Buscar cliente por nome..."
                        autocomplete="off"
                        class="search-input">
                    <div class="filter-checkbox-container">
                        <label class="filter-checkbox-label">
                            <input type="checkbox" id="filterDebtOnly" checked>
                            <span>Apenas com d√≠vidas</span>
                        </label>
                        <label class="filter-checkbox-label">
                            <input type="checkbox" id="filterArchived">
                            <span>Mostrar arquivados</span>
                        </label>
                    </div>
                </div>
                <div id="clientsListDiv" class="clients-list">
                    <p class="empty-message">Nenhum cliente cadastrado ainda.</p>
                </div>
            </section>
        </main>
    </div>

    <!-- Modal para detalhes do cliente -->
        <div id="clientModal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                
                <!-- Nome do cliente com edi√ß√£o inline -->
                <div class="client-name-section">
                    <h2 id="modalClientName" class="editable-name"></h2>
                    <button id="editNameBtn" class="btn-edit-name" title="Editar nome">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                        </svg>
                    </button>
                </div>
                
                <!-- Formul√°rio de edi√ß√£o (oculto por padr√£o) -->
                <form id="editNameForm" class="edit-name-form" style="display: none;">
                    <input type="text" id="editClientName" placeholder="Nome do cliente" required>
                    <div class="edit-name-actions">
                        <button type="submit" class="btn btn-primary btn-sm">‚úì Salvar</button>
                        <button type="button" id="cancelEditName" class="btn btn-secondary btn-sm">‚úï Cancelar</button>
                    </div>
                </form>
                
                <div class="modal-debt">
                    D√©bito total: <strong>R$ <span id="modalDebt">0,00</span></strong>
                </div>

                <h3>Registrar Pagamento</h3>
                <form id="paymentForm">
                    <input type="number" id="paymentAmount" placeholder="Valor do pagamento (R$)" step="0.01" min="0.01" required>
                    <button type="submit" class="btn btn-success">‚úì Registrar Pagamento</button>
                </form>

                <h3>Adicionar Nova Venda</h3>
                <form id="modalAddSaleForm">
                    <input type="number" id="modalSaleAmount" placeholder="Valor da venda (R$)" step="0.01" min="0.01" required>
                    <textarea id="modalSaleDescription" placeholder="Descri√ß√£o ou produto (opcional)" rows="3"></textarea>
                    <label class="checkbox-label">
                        <input type="checkbox" id="modalJustNoteProduct">
                        <span>üìù Apenas anotar produto (sem valor)</span>
                    </label>
                    <button type="submit" class="btn btn-primary">üíµ Adicionar Venda</button>
                </form>

                <div class="history-header">
                    <h3>Hist√≥rico de Vendas</h3>
                    <button id="shareHistory" class="btn btn-share" title="Compartilhar hist√≥rico">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="18" cy="5" r="3"/>
                            <circle cx="6" cy="12" r="3"/>
                            <circle cx="18" cy="19" r="3"/>
                            <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
                            <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
                        </svg>
                        Compartilhar
                    </button>
                </div>
                <div id="salesHistory" class="sales-history"></div>

                <div class="modal-actions">
                    <button id="archiveClient" class="btn btn-secondary">üì¶ Arquivar Cliente</button>
                    <button id="clearHistory" class="btn btn-warning">üßπ Limpar Hist√≥rico</button>
                    <button id="deleteClient" class="btn btn-danger">üóëÔ∏è Excluir Cliente</button>
                </div>
            </div>
        </div>

    <!-- Loader -->
    <div id="loader" class="loader-overlay">
        <div class="loader-spinner"></div>
        <p class="loader-text">Processando...</p>
    </div>

    <!-- Toast de Sucesso -->
    <div id="toast" class="toast">
        <span class="toast-icon">‚úì</span>
        <span class="toast-message">Salvo com sucesso!</span>
    </div>

    <!-- Modal de Confirma√ß√£o -->
    <div id="confirmModal" class="confirm-modal">
        <div class="confirm-modal-content">
            <div class="confirm-modal-icon">‚ö†Ô∏è</div>
            <h3 id="confirmTitle">Confirmar A√ß√£o</h3>
            <p id="confirmMessage">Tem certeza que deseja continuar?</p>
            <div class="confirm-modal-actions">
                <button id="confirmCancel" class="btn btn-secondary">Cancelar</button>
                <button id="confirmOk" class="btn btn-danger">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Edi√ß√£o de Venda -->
    <div id="editSaleModal" class="modal">
        <div class="modal-content modal-content-small">
            <span id="closeEditSaleModal" class="close">&times;</span>
            <h2>Editar <span id="editSaleType">Item</span></h2>
            <form id="editSaleForm">
                <input type="number" id="editSaleAmount" placeholder="Valor (R$)" step="0.01" min="0.01" required>
                <div id="editSaleDescriptionWrapper">
                    <textarea id="editSaleDescription" placeholder="Descri√ß√£o (opcional)" rows="3"></textarea>
                </div>
                <div class="modal-actions">
                    <button type="submit" class="btn btn-primary">‚úì Salvar</button>
                    <button type="button" id="cancelEditSale" class="btn btn-secondary">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module" src="app.js?v=1.8.0"></script>
</body>
</html>
